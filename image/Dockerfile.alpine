# -------------- Build-time variables --------------
ARG PHP_VERSION="8.0"
ARG ALPINE_VERSION="3.16"
# ---------------------------------------------------
### Build PHP base
FROM php:${PHP_VERSION}-fpm-alpine${ALPINE_VERSION}

COPY --chown=9000:9000 rootfs /

# BUILD: define build variables
ARG MOVIM_REPO="https://github.com/movim/movim"
ARG MOVIM_VERSION="v0.21rc3"
ARG USER="movim-user"
ARG UID="9000"
ARG GID="9000"
ARG S6_VERSION="v3.1.2.1"

# RUNTIME: define environment variables
ENV S6_BEHAVIOUR_IF_STAGE2_FAILS="2" \
       S6_CMD_WAIT_FOR_SERVICES_MAXTIME="0" \
       S6_READ_ONLY_ROOT="1" \
       MOVIM_HOME="/movim" \
       MOVIM_VERSION="$MOVIM_VERSION"

WORKDIR /tmp/builder

RUN set -x && apk -U upgrade --available --no-cache \
# BUILD: add build dependencies
       && apk add -t build-deps --no-cache \
              $PHPIZE_DEPS \
              curl \
              git \
              imagemagick-dev \
              libjpeg-turbo-dev \
              libpng-dev \
              libpq-dev \
              libwebp-dev \
              libzip-dev \
              zlib-dev \
       && apk add -t run-deps --no-cache \
              imagemagick \
              libgomp \
              libjpeg-turbo \
              libpng \
              libpq \
              libwebp \
              libzip \
              zlib \
# BUILD: build and install php extensions
       && docker-php-ext-configure gd --with-jpeg --with-webp \
       && docker-php-ext-install -j "$(nproc)" \
              gd \
              mysqli \
              pdo_mysql \
              pdo_pgsql \
              pgsql \
              zip \
        && pecl install imagick \
        && echo 'extension=imagick.so' > /usr/local/etc/php/conf.d/imagick.ini \
# BUILD: download and install movim
       && git clone ${MOVIM_REPO} --branch ${MOVIM_VERSION} --single-branch . \
       && curl -sS https://getcomposer.org/installer | php \
       && php composer.phar install --optimize-autoloader \
       && mkdir -p ${MOVIM_HOME}/log ${MOVIM_HOME}/cache ${MOVIM_HOME}/public/cache \
       && ln -s /usr/local/bin/php /usr/bin/php \
# RUNTIME: add runtime group and user
       && addgroup ${USER} -g ${GID} \
       && adduser -s /sbin/nologin -G ${USER} -u ${UID} -D -h ${MOVIM_HOME} --gecos "" ${USER} \
       && chown -R ${UID}:${GID} ${MOVIM_HOME} /tmp/builder \
# RUNTIME: install runtime init (s6-overlay)
       && ARCH=$(uname -m) \
       && wget -qO - https://github.com/just-containers/s6-overlay/releases/download/${S6_VERSION}/s6-overlay-noarch.tar.xz | tar xfJ - -C / \
       && wget -qO - https://github.com/just-containers/s6-overlay/releases/download/${S6_VERSION}/s6-overlay-${ARCH}.tar.xz | tar xfJ - -C / \
       && chmod +x /etc/cont-init.d/* /etc/s6-overlay/s6-rc.d/*/run \
       && ln -s /run /var/run \
# CLEANUP: Remove source files, build dependencies, etc.
       && apk del build-deps \
       && rm -rf /var/cache/apk/* /tmp/pear /tmp/builder/.git*

WORKDIR ${MOVIM_HOME}
EXPOSE 8080 9000
USER ${USER}
VOLUME ["${MOVIM_HOME}", "/php", "/run", "/tmp"]

ENTRYPOINT ["/init"]

